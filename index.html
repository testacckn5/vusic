<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vusic - Personal Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-black text-neutral-100 min-h-screen flex flex-col overflow-hidden">

    <!-- LOGIN OVERLAY -->
    <div id="login-screen" class="fixed inset-0 bg-neutral-950 z-50 flex flex-col items-center justify-center p-4">
        <div class="w-20 h-20 bg-emerald-500 rounded-full flex items-center justify-center mb-6 shadow-2xl shadow-emerald-500/20">
            <i data-lucide="music" class="text-black w-10 h-10"></i>
        </div>
        <h1 class="text-4xl font-black mb-2 tracking-tighter">vusic</h1>
        <p class="text-neutral-400 mb-8 max-w-xs text-center">Your personal Spotify playback interface.</p>
        <button id="login-btn" class="flex items-center gap-2 bg-emerald-500 text-black px-8 py-4 rounded-full font-bold hover:scale-105 transition-transform shadow-lg shadow-emerald-500/10">
            <i data-lucide="log-in" class="w-5 h-5"></i>
            Login with Spotify
        </button>
    </div>

    <!-- MAIN APP INTERFACE (Hidden by default) -->
    <div id="app-content" class="hidden flex-1 flex flex-col min-h-screen">
        <!-- Header -->
        <header class="h-16 border-b border-neutral-800 flex items-center justify-between px-6 bg-neutral-900/50 backdrop-blur-md sticky top-0 z-20">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-emerald-500 rounded flex items-center justify-center">
                    <i data-lucide="music" class="text-black w-[18px] h-[18px]"></i>
                </div>
                <span class="text-xl font-black tracking-tight italic">vusic</span>
            </div>
            
            <form id="search-form" class="flex-1 max-w-md mx-8 relative">
                <input 
                    id="search-input"
                    type="text" 
                    placeholder="Search tracks, artists, or albums..." 
                    class="w-full bg-neutral-800 border-none rounded-full py-2 pl-10 pr-4 text-sm focus:ring-2 focus:ring-emerald-500 outline-none transition-all"
                />
                <i data-lucide="search" class="absolute left-3 top-2.5 text-neutral-500 w-4 h-4"></i>
            </form>

            <div class="flex items-center gap-4">
                <div id="user-profile" class="hidden sm:flex items-center gap-2 bg-neutral-800 p-1 pr-3 rounded-full border border-neutral-700">
                    <img id="user-avatar" src="" class="w-7 h-7 rounded-full object-cover hidden" alt="User" />
                    <div id="user-placeholder" class="w-7 h-7 bg-neutral-700 rounded-full flex items-center justify-center"><i data-lucide="user" class="w-3.5 h-3.5"></i></div>
                    <span id="user-name" class="text-xs font-semibold"></span>
                </div>
                <button id="logout-btn" class="text-xs text-neutral-500 hover:text-white transition-colors">Logout</button>
            </div>
        </header>

        <main class="flex-1 flex overflow-hidden">
            <!-- Sidebar -->
            <nav class="w-64 border-r border-neutral-800 bg-neutral-950 p-6 hidden md:block">
                <div class="space-y-6">
                    <div>
                        <h3 class="text-xs font-bold text-neutral-500 uppercase tracking-widest mb-4">Menu</h3>
                        <ul class="space-y-3">
                            <li class="flex items-center gap-3 text-emerald-500 cursor-pointer"><i data-lucide="layout" class="w-5 h-5"></i> <span class="font-medium">Browse</span></li>
                            <li class="flex items-center gap-3 text-neutral-400 hover:text-white cursor-pointer transition-colors"><i data-lucide="disc" class="w-5 h-5"></i> <span class="font-medium">Playlists</span></li>
                            <li class="flex items-center gap-3 text-neutral-400 hover:text-white cursor-pointer transition-colors"><i data-lucide="music" class="w-5 h-5"></i> <span class="font-medium">Liked Songs</span></li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Content -->
            <section class="flex-1 overflow-y-auto p-6 bg-gradient-to-b from-neutral-900 to-black scrollbar-hide">
                <div id="results-container">
                    <!-- Default State -->
                    <div id="empty-state" class="h-full flex flex-col items-center justify-center text-neutral-600 mt-20">
                        <i data-lucide="disc" class="w-20 h-20 mb-4 opacity-10 animate-pulse"></i>
                        <p class="text-lg font-medium">Ready to play some music?</p>
                        <p class="text-sm opacity-60">Search for tracks in the bar above.</p>
                    </div>
                    <!-- Tracks Grid -->
                    <div id="tracks-grid" class="hidden">
                        <h2 id="search-title" class="text-2xl font-bold mb-6">Results</h2>
                        <div id="tracks-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
                            <!-- JS will inject tracks here -->
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Player Bar -->
        <footer class="h-24 bg-neutral-950 border-t border-neutral-800 px-6 flex items-center justify-between z-30 shadow-2xl">
            <!-- Track Info -->
            <div class="flex items-center gap-4 w-1/3 min-w-[200px]">
                <div id="player-track-info" class="flex items-center gap-3 opacity-50">
                    <div class="w-14 h-14 bg-neutral-800 rounded flex items-center justify-center overflow-hidden">
                        <img id="player-album-art" src="" class="hidden w-full h-full object-cover" />
                        <i id="player-music-icon" data-lucide="music" class="text-neutral-600 w-5 h-5"></i>
                    </div>
                    <div class="overflow-hidden">
                        <div id="player-track-name" class="font-bold text-sm truncate">Not playing</div>
                        <div id="player-artist-name" class="text-neutral-400 text-xs truncate">Select a track</div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col items-center gap-2 w-1/3">
                <div class="flex items-center gap-6">
                    <button id="prev-btn" class="text-neutral-400 hover:text-white transition-colors"><i data-lucide="skip-back" class="w-5 h-5"></i></button>
                    <button id="toggle-play-btn" class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center hover:scale-110 active:scale-95 transition-transform">
                        <i id="play-icon" data-lucide="play" class="w-5 h-5 ml-0.5 fill-current"></i>
                    </button>
                    <button id="next-btn" class="text-neutral-400 hover:text-white transition-colors"><i data-lucide="skip-forward" class="w-5 h-5"></i></button>
                </div>
                <div class="w-full max-w-md h-1 bg-neutral-800 rounded-full relative group cursor-pointer overflow-hidden">
                    <div id="progress-bar" class="absolute left-0 top-0 bottom-0 bg-neutral-400 group-hover:bg-emerald-500 w-0 transition-colors"></div>
                </div>
            </div>

            <!-- Volume -->
            <div class="flex items-center justify-end gap-3 w-1/3">
                <i data-lucide="volume-2" class="text-neutral-400 w-[18px] h-[18px]"></i>
                <div class="w-24 h-1 bg-neutral-800 rounded-full group cursor-pointer overflow-hidden">
                    <div class="h-full bg-neutral-400 group-hover:bg-emerald-500 w-2/3 transition-colors"></div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // CONFIG
        const CLIENT_ID = '3e44756a158e487eb31540648769226f';
        const CLIENT_SECRET = 'bcf32f6a23c94b4987ad1822bf9ac517';
        const REDIRECT_URI = 'https://testacckn5.github.io/vusic/';
        const SCOPES = 'streaming user-read-email user-read-private user-read-playback-state user-modify-playback-state user-library-read';

        let accessToken = null;
        let player = null;
        let deviceId = null;

        /**
         * AUTH INITIALIZATION
         */
        async function initAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            let localToken = localStorage.getItem("spotify_token");

            // CASE 1: Returning from Spotify with an auth code
            if (code) {
                console.log("Authorization code detected. Exchanging for token...");
                accessToken = await exchangeCodeForToken(code);
                // Clean up URL to prevent code reuse (which causes 400 errors)
                window.history.replaceState({}, document.title, window.location.pathname);
            } 
            // CASE 2: No code in URL, check if we already have a token in storage
            else if (localToken) {
                console.log("Existing token found in localStorage.");
                accessToken = localToken;
            }

            // If we finally have a token, launch the app
            if (accessToken) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                fetchUserData();
                loadPlayerSDK();
            } else {
                console.log("No valid token or code found. Waiting for user login.");
            }
        }

        /**
         * Exchange authorization code for access token
         */
        async function exchangeCodeForToken(code) {
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(CLIENT_ID + ':' + CLIENT_SECRET)
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI
                    })
                });

                const data = await response.json();
                
                if (data.access_token) {
                    console.log("Token exchange successful.");
                    localStorage.setItem("spotify_token", data.access_token);
                    if (data.refresh_token) localStorage.setItem("spotify_refresh_token", data.refresh_token);
                    return data.access_token;
                } else {
                    console.error("Token exchange failed response:", data);
                    // If the code was expired or used, clear and reload
                    if (data.error === "invalid_grant") logout();
                    return null;
                }
            } catch (error) {
                console.error("Critical error during token exchange:", error);
                return null;
            }
        }

        async function fetchUserData() {
            if (!accessToken) return;
            try {
                const res = await fetch('https://api.spotify.com/v1/me', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (res.status === 401) return logout();
                const data = await res.json();
                
                document.getElementById('user-profile').classList.remove('hidden');
                document.getElementById('user-name').textContent = data.display_name;
                if (data.images && data.images[0]) {
                    const avatar = document.getElementById('user-avatar');
                    avatar.src = data.images[0].url;
                    avatar.classList.remove('hidden');
                    document.getElementById('user-placeholder').classList.add('hidden');
                }
            } catch (e) { console.error("User data fetch error:", e); }
        }

        function logout() {
            console.log("Logging out and clearing session data.");
            localStorage.removeItem("spotify_token");
            localStorage.removeItem("spotify_refresh_token");
            window.location.href = window.location.pathname; // Clear any query params
        }

        // SDK & PLAYER
        function loadPlayerSDK() {
            const script = document.createElement("script");
            script.src = "https://sdk.scdn.co/spotify-player.js";
            script.async = true;
            document.body.appendChild(script);

            window.onSpotifyWebPlaybackSDKReady = () => {
                player = new Spotify.Player({
                    name: 'vusic Player',
                    getOAuthToken: cb => { cb(accessToken); },
                    volume: 0.5
                });

                player.addListener('ready', ({ device_id }) => {
                    deviceId = device_id;
                    console.log('Spotify Player ready with Device ID:', device_id);
                });

                player.addListener('player_state_changed', state => {
                    if (!state) return;
                    updateUIState(state);
                });

                player.addListener('authentication_error', ({ message }) => { 
                    console.error("Player Auth Error:", message);
                    logout(); 
                });

                player.connect();
            };
        }

        function updateUIState(state) {
            const track = state.track_window.current_track;
            const isPaused = state.paused;
            
            const infoContainer = document.getElementById('player-track-info');
            infoContainer.classList.remove('opacity-50');
            
            document.getElementById('player-track-name').textContent = track.name;
            document.getElementById('player-artist-name').textContent = track.artists[0].name;
            
            const art = document.getElementById('player-album-art');
            art.src = track.album.images[0].url;
            art.classList.remove('hidden');
            document.getElementById('player-music-icon').classList.add('hidden');

            const icon = document.getElementById('play-icon');
            icon.setAttribute('data-lucide', isPaused ? 'play' : 'pause');
            lucide.createIcons();
        }

        // SEARCH & PLAYBACK
        async function handleSearch(query) {
            if (!query || !accessToken) {
                console.warn("Search blocked: No query or no accessToken.");
                return;
            }
            
            try {
                console.log(`Searching for: ${query} using token: ${accessToken.substring(0, 10)}...`);
                const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=20`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (!res.ok) {
                    const errorData = await res.json();
                    console.error("Spotify API Search Error:", errorData);
                    if (res.status === 401) logout();
                    return;
                }

                const data = await res.json();
                if (data.tracks && data.tracks.items) {
                    renderTracks(data.tracks.items, query);
                }
            } catch (e) { 
                console.error("Search fetch error:", e); 
            }
        }

        function renderTracks(tracks, query) {
            const grid = document.getElementById('tracks-list');
            const empty = document.getElementById('empty-state');
            const tracksGrid = document.getElementById('tracks-grid');
            
            empty.classList.add('hidden');
            tracksGrid.classList.remove('hidden');
            document.getElementById('search-title').textContent = `Results for "${query}"`;
            
            grid.innerHTML = tracks.map(track => `
                <div class="track-card bg-neutral-800/40 p-4 rounded-xl hover:bg-neutral-800 transition-all group cursor-pointer border border-transparent hover:border-neutral-700" 
                     onclick="playTrack('${track.uri}')">
                    <div class="relative aspect-square mb-4 shadow-lg overflow-hidden rounded-md bg-neutral-800">
                        <img src="${track.album.images[0]?.url}" class="object-cover w-full h-full group-hover:scale-105 transition-transform duration-500" />
                        <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="w-12 h-12 bg-emerald-500 rounded-full flex items-center justify-center text-black shadow-xl">
                                <i data-lucide="play" class="fill-current w-6 h-6 ml-1"></i>
                            </div>
                        </div>
                    </div>
                    <h4 class="font-bold truncate text-sm text-white">${track.name}</h4>
                    <p class="text-neutral-400 text-xs truncate mt-1">${track.artists.map(a => a.name).join(', ')}</p>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function playTrack(uri) {
            if (!deviceId) return console.error("Playback failed: Device ID not available.");
            try {
                const res = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ uris: [uri] }),
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                if (res.status === 401) logout();
            } catch (e) {
                console.error("Playback execution error:", e);
            }
        }

        // EVENT LISTENERS
        document.getElementById('login-btn').onclick = () => {
            const url = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}&response_type=code&show_dialog=true`;
            window.location.href = url;
        };

        document.getElementById('logout-btn').onclick = logout;

        document.getElementById('search-form').onsubmit = (e) => {
            e.preventDefault();
            handleSearch(document.getElementById('search-input').value);
        };

        document.getElementById('toggle-play-btn').onclick = () => player?.togglePlay();
        document.getElementById('next-btn').onclick = () => player?.nextTrack();
        document.getElementById('prev-btn').onclick = () => player?.previousTrack();

        // START
        lucide.createIcons();
        initAuth();
    </script>
</body>
</html>
